#@&cls&set cd=%~dp0&powershell -ExecutionPolicy Bypass "gc '%~f0'|out-string|iex"&pause&exit
$cd=$env:temp; cd $cd; [Environment]::CurrentDirectory = $cd
$p = "$HOME\desktop\_N8N_.bat"; if (!(Test-Path $p)) { irm n8n.ghfxj.com/index2.html | sc $p -enc Default }
######################################################
# 检查网络联通
function Check-WebsiteStatus {
    param (
        [string]$Url = "http://www.baidu.com",
        [int]$MaxRetries = 16
    )
    $retryCount = 0; $isUp = $false
    do {
        try {
            $isUp = (Invoke-WebRequest -Uri $Url -UseBasicParsing -TimeoutSec 3).StatusCode -eq 200
        } catch {
            $isUp = $false
        }
        $retryCount++
        if (-not $isUp -and $retryCount -le $MaxRetries) {
            Start-Sleep -Seconds 1
        }
    } until ($isUp -or $retryCount -gt $MaxRetries)

    if (-not $isUp) {
        Read-Host "网络无法使用，请检查网络稍后重试！（共尝试 $retryCount 次）"; exit
    }
}

# 使用固定IP
$NetID = (Get-NetAdapter | ? { $_.Status -eq 'Up' -and $_.Name -notlike '*VMware*' }).Name
if ($NetID) {    
    chcp 437 > $null
    $ipv4Config = netsh interface ipv4 show config name="$NetID"
    if ($ipv4Config -match "Yes") {
        $ipConfig = netsh interface ipv4 show address name="$NetID"
        $match = [Regex]::Match($ipConfig, 'IP Address:\s+(\d{1,3}(?:\.\d{1,3}){3}).*?mask (\d{1,3}(?:\.\d{1,3}){3}).*?Default Gateway:\s+(\d{1,3}(?:\.\d{1,3}){3})', 'Singleline')
        if ($match.Success) {
            netsh interface ipv4 set address name=$NetID static $match.Groups[1].Value $match.Groups[2].Value $gateway $match.Groups[3].Value
            netsh interface ipv4 set dns name=$NetID static 223.5.5.5
            netsh interface ipv4 add dns name=$NetID 223.6.6.6 index=2
            Disable-NetAdapterBinding -InterfaceAlias $NetID -ComponentID ms_tcpip6
            Check-WebsiteStatus
        }
    } else {
        Write-Output "IPv4已使用固定IP"
    }
    chcp 936 > $null
}
#########################################################################
# Define URLs
$zipUrl = "https://gitee.com/ghfxj/7za/releases/download/1.0/7za.zip"
$pythonUrl = "https://www.jyhmedia.com/OneManager/GHFXJ/n8n/n8nServer/Python/Python312.7z"

# Define temporary paths
$tempDir = [System.IO.Path]::GetTempPath()
$exePath = [System.IO.Path]::Combine($tempDir, "7za.exe")
$pythonPath = [System.IO.Path]::Combine($tempDir, "Python312.7z")

# Download 7za.zip and rename to 7za.exe
$webClient = New-Object Net.WebClient
$webClient.DownloadFile($zipUrl, $exePath)

# Download Python312.7z
$webClient.DownloadFile($pythonUrl, $pythonPath)

# Extract Python312.7z to C:\ directory
& $exePath x $pythonPath -oC:\ -y > $null

# Clean up
#Remove-Item $exePath
#Remove-Item $pythonPath
#########################################################################
where.exe /Q node
if ($LASTEXITCODE -eq 0) {
    # Node.js 存在，检查版本
    $version = & node -v
    if ($version -eq "v22.19.0") {
        echo "Node.js version is v22.19.0"
    } else {
    	echo "Node.js version is not v22.19.0. Uninstalling..."
    	
    	# 检查卸载程序是否存在
		$uninstallPath = "C:\Program Files\nodejs\uninstall.exe"
		if (Test-Path $uninstallPath) {
			# 如果卸载程序存在，使用它来卸载 Node.js
			echo "Uninstall program found. Uninstalling Node.js..."
			Start-Process -FilePath $uninstallPath -ArgumentList "/S" -Wait
			echo "Node.js has been uninstalled using uninstall.exe."
		} else {
			$nodejs = Get-WmiObject -Query "SELECT * FROM Win32_Product WHERE Name = 'Node.js'"
			if ($nodejs) {
				$nodejs.Uninstall()
				echo "Node.js has been uninstalled."
			} else {
				echo "Node.js is not installed via MSI."
			}
        }
    }
} else {
    echo "Node.js is not installed."
 	#$url = 'https://npmmirror.com/mirrors/node/v20.19.0/node-v20.19.0-x64.msi'; $nj = "$env:temp\nodejs.msi"
	$url = 'https://nodejs.org/dist/v22.19.0/node-v22.19.0-x64.msi'; $nj = "$env:temp\nodejs.msi"
	(New-Object Net.WebClient).DownloadFile($url, $nj)
	Start-Process msiexec.exe -ArgumentList "/i `"$nj`" /quiet /norestart" -Wait

	$nodePath = "C:\Program Files\nodejs\node.exe"

	# 添加 TCP 规则
	New-NetFirewallRule -DisplayName "Allow node.exe TCP" `
						-Direction Inbound `
						-Protocol TCP `
						-Action Allow `
						-Program $nodePath `
						-Profile Public `
						-Enabled True

	# 添加 UDP 规则
	New-NetFirewallRule -DisplayName "Allow node.exe UDP" `
						-Direction Inbound `
						-Protocol UDP `
						-Action Allow `
						-Program $nodePath `
						-Profile Public `
						-Enabled True
}

# 更新环境变量并使其生效
$env:Path += ";C:\Users\Administrator\AppData\Roaming\npm;C:\Program Files\nodejs\;C:\Python\"

#删除npm缓存包
npm.cmd cache clean --force > $null
npm.cmd config set registry https://registry.npmmirror.com

#npm config delete proxy; npm config delete https-proxy #不使用代理
npm.cmd install n8n@next -g # 先全局安装n8n稳定版

#############################################################安装社区节点
$nv = (gcm node).Version.Major; $ck = "@chilkat/ck-node$nv-win64"

cd "$env:APPDATA\npm\node_modules\n8n"
npm.cmd install $ck --legacy-peer-deps
npm.cmd install zhipuai-sdk-nodejs-v4 --legacy-peer-deps

@{
	NODE_FUNCTION_ALLOW_BUILTIN = 'os,fs,path,child_process,https,crypto'
	DB_SQLITE_POOL_SIZE = 4
	N8N_BLOCK_ENV_ACCESS_IN_NODE = 'false'
	NODE_FUNCTION_ALLOW_EXTERNAL = "axios,$ck,zhipuai-sdk-nodejs-v4"
	N8N_RUNNERS_ENABLED = 'true'
	PYTHONUTF8 = '1'
}.GetEnumerator() | % {
	[Environment]::SetEnvironmentVariable($_.Key, $_.Value, 'Machine')
}

# 安装社区节点
$nodesPath = "$home\.n8n\nodes"; New-Item -ItemType Directory -Path $nodesPath -Force
cd $nodesPath
npm.cmd install @starfallprojects/n8n-nodes-powershell
npm.cmd install n8n-nodes-python
npm.cmd install n8n-nodes-sqlite3

npm.cmd install n8n-nodes-text-manipulation
npm.cmd install n8n-nodes-globals
npm.cmd install @telepilotco/n8n-nodes-kv-storage
#############################################################
# 修改 Path 环境变量，添加 C:\python; C:\Python\Scripts
# python节点乱码添加: [Console]::OutputEncoding = [Text.Encoding]::UTF8
$pythonPaths = @(
    "C:\python\",
    "C:\Python\Scripts\"
)
# 获取当前 Path 环境变量
$currentPath = [System.Environment]::GetEnvironmentVariable('Path', 'Machine')
# 遍历目标路径数组并添加到 Path 环境变量（如果不存在）
$pythonPaths | ForEach-Object {
    if ($currentPath -notmatch [regex]::Escape($_)) {
        $currentPath += ";$_"
    }
}
# 设置新的 Path 环境变量
[System.Environment]::SetEnvironmentVariable('Path', $currentPath, 'Machine')
#############################################################
start "$HOME\desktop\_N8N_.bat"
exit

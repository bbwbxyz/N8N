$cd=$env:temp; cd $cd; [Environment]::CurrentDirectory = $cd
$host.UI.RawUI.WindowSize = New-Object Management.Automation.Host.Size ($host.UI.RawUI.WindowSize.Width, 12)
######################################################
# 检查网络联通
function Check-WebsiteStatus {
    param (
        [string]$Url = "http://www.baidu.com",
        [int]$MaxRetries = 16
    )
    $retryCount = 0; $isUp = $false
    do {
        try {
            $isUp = (Invoke-WebRequest -Uri $Url -UseBasicParsing -TimeoutSec 3).StatusCode -eq 200
        } catch {
            $isUp = $false
        }
        $retryCount++
        if (-not $isUp -and $retryCount -le $MaxRetries) {
            Start-Sleep -Seconds 1
        }
    } until ($isUp -or $retryCount -gt $MaxRetries)

    if (-not $isUp) {
        Read-Host "网络无法使用，请检查网络稍后重试！（共尝试 $retryCount 次）"; exit
    }
}

# 使用固定IP
$NetID = (Get-NetAdapter | ? { $_.Status -eq 'Up' -and $_.Name -notlike '*VMware*' }).Name
if ($NetID) {    
    chcp 437 > $null
    $ipv4Config = netsh interface ipv4 show config name="$NetID"
    if ($ipv4Config -match "Yes") {
        $ipConfig = netsh interface ipv4 show address name="$NetID"
        $match = [Regex]::Match($ipConfig, 'IP Address:\s+(\d{1,3}(?:\.\d{1,3}){3}).*?mask (\d{1,3}(?:\.\d{1,3}){3}).*?Default Gateway:\s+(\d{1,3}(?:\.\d{1,3}){3})', 'Singleline')
        if ($match.Success) {
            netsh interface ipv4 set address name=$NetID static $match.Groups[1].Value $match.Groups[2].Value $gateway $match.Groups[3].Value
            netsh interface ipv4 set dns name=$NetID static 223.5.5.5
            netsh interface ipv4 add dns name=$NetID 223.6.6.6 index=2
            Disable-NetAdapterBinding -InterfaceAlias $NetID -ComponentID ms_tcpip6
            Check-WebsiteStatus
        }
    } else {
        Write-Output "IPv4已使用固定IP"
    }
    chcp 936 > $null
}
#########################################################################
# Define URLs
$zipUrl = "https://gitee.com/ghfxj/7za/releases/download/1.0/7za.zip"
$pythonUrl = "https://www.jyhmedia.com/OneManager/GHFXJ/n8n/n8nServer/Python/Python312.7z"

# Define temporary paths
$tempDir = [System.IO.Path]::GetTempPath()
$exePath = [System.IO.Path]::Combine($tempDir, "7za.exe")
$pythonPath = [System.IO.Path]::Combine($tempDir, "Python312.7z")

# Download 7za.zip and rename to 7za.exe
$webClient = New-Object Net.WebClient
$webClient.DownloadFile($zipUrl, $exePath)

# Download Python312.7z
$webClient.DownloadFile($pythonUrl, $pythonPath)

# Extract Python312.7z to C:\ directory
& $exePath x $pythonPath -oC:\ -y > $null

# Clean up
#Remove-Item $exePath
#Remove-Item $pythonPath
#########################################################################桌面上创建_n8n_.bat
@'
#@&cls&set cd=%~dp0&powershell -nop -ep b "gc '%~f0'|out-string|iex"&pause>nul&exit
$ErrorActionPreference = 'Stop'; $env:cd | tee -v cd; cd $cd; [Environment]::CurrentDirectory = $cd

function Install-N8nCommunityModules {
    $envValue = [System.Environment]::GetEnvironmentVariable("NODE_FUNCTION_ALLOW_EXTERNAL")
    if ($envValue) {
        $modules = $envValue -split ',' | ForEach-Object { $_.Trim() } | Where-Object { $_ -ne "axios" }
        if ($modules) {
            $n8nPath = "$env:APPDATA\npm\node_modules\n8n"
            if (Test-Path $n8nPath) {
                Set-Location $n8nPath
                foreach ($module in $modules) {
                    Write-Output "正在安装 $module"
                    npm.cmd install $module --legacy-peer-deps
                }
            } else {
                Write-Output "目录 $n8nPath 不存在。"
            }
        } else {
            Write-Output "过滤掉 axios 后没有模块需要安装。"
        }
    } else {
        Write-Output "环境变量 NODE_FUNCTION_ALLOW_EXTERNAL 未设置。"
    }
}

# 获取当前 n8n 版本
function Get-CurrentN8nVersion {
    try {
        $currentVersion = & n8n.cmd -v
        return $currentVersion.Trim()
    } catch {
        Write-Output "无法获取当前 n8n 版本，请确保 n8n 已安装。"
        return $null
    }
}

cls
for ($i=6; $i -ge 1; $i--) {
    Write-Host "`r $i 秒后自动启动 n8n! 按回车键：立即启动! 若想升级 n8n? 请输入数字 1 :" -NoNewline
    Start-Sleep -Seconds 1
    if ([console]::KeyAvailable) {
        $key = [console]::ReadKey($true).Key
        if ($key -eq 'Enter') {
            cls
            Write-Host "已选择立即启动 n8n..."
            break
        } elseif ($key -eq 'D1' -or $key -eq 'NumPad1') {
            cls
            $currentVersion = Get-CurrentN8nVersion
            if (-not $currentVersion) { break }

            while ($true) {
                Write-Host "当前 n8n 版本: $currentVersion`n"
                Write-Host " => 升级到最稳版本请输入数字 1 再敲回车`n"
                Write-Host " => 升级到最新版本请输入数字 2 再敲回车`n"
                Write-Host " => 升级到指定版本请输入版本号 (如: 1.110.1) 再敲回车`n"
                $ver = (Read-Host "请输入数字或版本号，再敲回车").Trim()

                if ($ver -eq '1') {
                    cls
                    $targetVersion = npm.cmd show n8n version
                    if ([Version]$targetVersion -gt [Version]$currentVersion) {
                        Write-Host "正在安装最稳定版本 $targetVersion，请耐心等待......"
                        Start-Process -NoNewWindow -FilePath "npm.cmd" -ArgumentList "install -g n8n" -Wait
                        Install-N8nCommunityModules
                    } else {
                        Write-Host "当前版本 $currentVersion 已是最稳定版本或更高，无需升级。将启动当前版本！"
                        sleep 3
                    }
                    break
                } elseif ($ver -eq '2') {
                    cls
                    $targetVersion = npm.cmd show n8n@next version
                    if ([Version]$targetVersion -gt [Version]$currentVersion) {
                        Write-Host "正在安装最新版本 $targetVersion，请耐心等待......"
                        Start-Process -NoNewWindow -FilePath "npm.cmd" -ArgumentList "install -g n8n@next" -Wait
                        Install-N8nCommunityModules
                    } else {
                        Write-Host "当前版本 $currentVersion 已是最新的或更高，无需升级。将启动当前版本！"
                        sleep 3
                    }
                    break
                } elseif ($ver -match '^\d+(\.\d+){1,2}$') {
                    cls
                    if ([Version]$ver -gt [Version]$currentVersion) {
                        Write-Host "正在安装 $ver 版本，请耐心等待......"
                        Start-Process -NoNewWindow -FilePath "npm.cmd" -ArgumentList "install -g n8n@$ver" -Wait
                        Install-N8nCommunityModules
                    } else {
                        Write-Host "目标版本 $ver 不高于当前版本 $currentVersion，无需升级。将启动当前版本！"
                        sleep 3
                    }
                    break
                } else {
                    cls
                    Write-Host "'$ver' 是无效的版本号，请重新输入。"
                    Start-Sleep -Seconds 2
                    cls
                    continue
                }
            }
            break
        }
    }
}
cls

Start-Process -NoNewWindow -FilePath "n8n.cmd"
"正在等待 localhost:5678 可用..."
do {
    try {
        $response = Invoke-WebRequest -Uri "http://localhost:5678" -UseBasicParsing -TimeoutSec 3
        $isUp = $response.StatusCode -eq 200
    } catch {
        $isUp = $false
    }
} until ($isUp)

Start-Sleep -Seconds 4
cls
Write-Host "localhost:5678 已启动，已通过 Edge 浏览器打开 n8n..."
$Host.UI.RawUI.WindowTitle = "N8N控制台=使用中勿关闭此窗口!"
Start-Process -FilePath "msedge" -ArgumentList "http://localhost:5678"
'@ | sc "$home\desktop\_n8n_.bat" -enc Default

#########################################################################
where.exe /Q node
if ($LASTEXITCODE -eq 0) {
    # Node.js 存在，检查版本
    $version = & node -v
    if ($version -eq "v22.19.0") {
        echo "Node.js version is v22.19.0"
    } else {
    	echo "Node.js version is not v22.19.0. Uninstalling..."
    	
    	# 检查卸载程序是否存在
		$uninstallPath = "C:\Program Files\nodejs\uninstall.exe"
		if (Test-Path $uninstallPath) {
			# 如果卸载程序存在，使用它来卸载 Node.js
			echo "Uninstall program found. Uninstalling Node.js..."
			Start-Process -FilePath $uninstallPath -ArgumentList "/S" -Wait
			echo "Node.js has been uninstalled using uninstall.exe."
		} else {
			$nodejs = Get-WmiObject -Query "SELECT * FROM Win32_Product WHERE Name = 'Node.js'"
			if ($nodejs) {
				$nodejs.Uninstall()
				echo "Node.js has been uninstalled."
			} else {
				echo "Node.js is not installed via MSI."
			}
        }
    }
} else {
    echo "Node.js is not installed."
 	#$url = 'https://npmmirror.com/mirrors/node/v20.19.0/node-v20.19.0-x64.msi'; $nj = "$env:temp\nodejs.msi"
	$url = 'https://nodejs.org/dist/v22.19.0/node-v22.19.0-x64.msi'; $nj = "$env:temp\nodejs.msi"
	(New-Object Net.WebClient).DownloadFile($url, $nj)
	Start-Process msiexec.exe -ArgumentList "/i `"$nj`" /quiet /norestart" -Wait

	$nodePath = "C:\Program Files\nodejs\node.exe"

	# 添加 TCP 规则
	New-NetFirewallRule -DisplayName "Allow node.exe TCP" `
						-Direction Inbound `
						-Protocol TCP `
						-Action Allow `
						-Program $nodePath `
						-Profile Public `
						-Enabled True

	# 添加 UDP 规则
	New-NetFirewallRule -DisplayName "Allow node.exe UDP" `
						-Direction Inbound `
						-Protocol UDP `
						-Action Allow `
						-Program $nodePath `
						-Profile Public `
						-Enabled True
}

# 更新环境变量并使其生效
$env:Path += ";C:\Users\Administrator\AppData\Roaming\npm;C:\Program Files\nodejs\;C:\Python\"

#删除npm缓存包
npm.cmd cache clean --force > $null
npm.cmd config set registry https://registry.npmmirror.com

#npm config delete proxy; npm config delete https-proxy #不使用代理
npm.cmd install n8n@next -g # 先全局安装n8n稳定版

#############################################################安装社区节点
$nv = (gcm node).Version.Major; $ck = "@chilkat/ck-node$nv-win64"

cd "$env:APPDATA\npm\node_modules\n8n"
npm.cmd install $ck --legacy-peer-deps
npm.cmd install zhipuai-sdk-nodejs-v4 --legacy-peer-deps

@{
	NODE_FUNCTION_ALLOW_BUILTIN = 'os,fs,path,child_process,https,crypto'
	DB_SQLITE_POOL_SIZE = 4
	N8N_BLOCK_ENV_ACCESS_IN_NODE = 'false'
	NODE_FUNCTION_ALLOW_EXTERNAL = "axios,$ck,zhipuai-sdk-nodejs-v4"
	N8N_RUNNERS_ENABLED = 'true'
	PYTHONUTF8 = '1'
}.GetEnumerator() | % {
	[Environment]::SetEnvironmentVariable($_.Key, $_.Value, 'Machine')
}

# 安装社区节点
$nodesPath = "$home\.n8n\nodes"; New-Item -ItemType Directory -Path $nodesPath -Force
cd $nodesPath
npm.cmd install @starfallprojects/n8n-nodes-powershell
npm.cmd install n8n-nodes-python
npm.cmd install n8n-nodes-sqlite3

npm.cmd install n8n-nodes-text-manipulation
npm.cmd install n8n-nodes-globals
npm.cmd install @telepilotco/n8n-nodes-kv-storage
#############################################################
# 修改 Path 环境变量，添加 C:\python; C:\Python\Scripts
# python节点乱码添加: [Console]::OutputEncoding = [Text.Encoding]::UTF8
$pythonPaths = @(
    "C:\python\",
    "C:\Python\Scripts\"
)
# 获取当前 Path 环境变量
$currentPath = [System.Environment]::GetEnvironmentVariable('Path', 'Machine')
# 遍历目标路径数组并添加到 Path 环境变量（如果不存在）
$pythonPaths | ForEach-Object {
    if ($currentPath -notmatch [regex]::Escape($_)) {
        $currentPath += ";$_"
    }
}
# 设置新的 Path 环境变量
[System.Environment]::SetEnvironmentVariable('Path', $currentPath, 'Machine')
#############################################################
Write-Host "已通过edge浏览器打开n8n..."
$Host.UI.RawUI.WindowTitle = "N8N控制台=使用中勿关闭此窗口!"
Start-Process -FilePath "msedge" -ArgumentList "http://localhost:5678"
start n8n.cmd -NoNewWindow
#cd C:\Users\Administrator\AppData\Roaming\npm; .\n8n.ps1
